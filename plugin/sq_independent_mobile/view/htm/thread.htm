<?php include _include(APP_PATH . SQ_MOBILE_PATH . 'view/htm/header.inc.htm');?>

<!--{hook thread_start.htm}-->

<div class="row">
	<div class="col-lg-9 main sq-thread-page">
		<!--{hook thread_breadcrumb_before.htm}-->
		<?php if(empty($hide_breadcrumb)) { ?>
		<ol class="breadcrumb d-none d-md-flex">
			<li class="breadcrumb-item"><a href="./" aria-label="<?php echo lang('index_page');?>"><i class="icon-home"></i></a></li>
			<li class="breadcrumb-item"><a href="<?php echo url("forum-$fid");?>"><?php echo $forum['name'];?></a></li>
			<li class="breadcrumb-item active"><a href="<?php echo url("thread-$tid");?>" title="<?php echo lang('index_page');?>返回主题第一页"><?php echo $thread['subject'];?></a></li>
			<!--{hook thread_breadcrumb.htm}-->
		</ol>
		<?php } ?>
		<!--{hook thread_breadcrumb_after.htm}-->

		<div class="row">
			<div class="col-12 sq-thread">
				<div class="sq-thread-subject">
					<h4 class="break-all">
						<?php echo $thread['subject']; ?>
					</h4>
				</div>
				<div class="sq-thread-info">
					<div class="sq-thread-info-left">
						<a href="<?php echo url("user-$thread[uid]");?>" tabindex="-1">
							<img class="avatar-3" src="<?php echo $thread['user_avatar_url'];?>">
						</a>
					</div>
					<div class="sq-thread-info-right">
						<div>
							<span class="username">
								<a href="<?php echo url("user-$thread[uid]");?>" class="text-muted font-weight-bold"><?php echo $thread['username'];?></a>
							</span>
						</div>			
						<div>
							<div>
								<span class="date text-grey"><?php echo $thread['create_date_fmt'];?></span>
							</div>
							<div>
								<span class="text-grey"><i class="sq-iconfont sq-iconfont-st">&#xe645;</i> <?php echo $thread['views'];?></span>
								<!--{hook thread_icon_right.htm}-->
							</div>
						</div> 
					</div>
				</div>
				<div class="sq-thread-message">
					<?php if($page == 1) { ?>
				
						<!--{hook thread_message_before.htm}-->
						<?php echo $first['message_fmt'];?>
						<!--{hook thread_message_after.htm}-->
						
						<?php echo post_file_list_html($first['filelist']);?>
						<!--{hook thread_filelist_after.htm}-->
						
					<?php } else { ?>
					
						<!--{hook thread_message_more_before.htm}-->
						<p><a href="<?php echo url("thread-$tid");?>"><?php echo lang('view_thread_message');?></a></p>
						<!--{hook thread_message_more_after.htm}-->
						
					<?php } ?>
				</div>

				<?php if($allowupdate || $allowdelete) { ?>
				<div class="sq-thread-bottom">
					<!--{hook thread_update_before.htm}-->
					<?php if($allowupdate || $first['allowupdate']) { ?>
					<a href="<?php echo url("post-update-$thread[firstpid]");?>" class="text-grey post_update">
						<!-- <i class="icon-edit"></i> -->
						<i class="sq-iconfont sq-iconfont-st">&#xe602;</i>
						<?php echo lang('edit');?>
					</a>
					<?php } ?>
					
					<?php if($allowdelete || $first['allowdelete']) { ?>
					<a data-href="<?php echo url("post-delete-$thread[firstpid]");?>" href="javascript:void(0);" class="text-grey post_delete" isfirst="1">
						<!-- <i class="icon-remove"></i> -->
						<i class="sq-iconfont sq-iconfont-st">&#xe693;</i>
						<?php echo lang('delete');?>
					</a>
					<?php } ?>
					<!--{hook thread_delete_after.htm}-->
				</div>
				<?php } ?>
			</div>
		</div>

		<div class="row sq-thread-hr"></div>

		<!--{hook thread_postlist_before.htm}-->

		<div class="row sq-thread-postlist">
			<div class="col-12">
				<div class="sq-thread-postlist-header">
					<div>
						<b><?php echo lang('new_post');?></b> (<span class="posts"><?php echo $thread['posts'];?></span>)
					</div>
					<!--{hook thread_post_list_title_middle.htm}-->
					<div>
					<!--{hook thread_post_list_title_right.htm}-->
					</div>
				</div>
				<ul class="list-unstyled postlist">
					<?php include _include(APP_PATH . SQ_MOBILE_PATH . 'view/htm/thread_post_list.inc.htm'); ?>
					
					<?php if(!empty($user)) { ?>
					<li class="post newpost media" id="sqReplyContainer">
						<!--
						<div class="media-body">
							<div class="d-flex justify-content-between small text-muted" id="sqPostFloor">
								<div>
									<div><?php echo $user['username'];?></div>
								</div>
								<div>
									<span class="floor" id="newfloor"><?php echo ($thread['posts'] + 2);?></span><?php echo lang('floor');?>
								</div>
							</div>
							
							<form action="<?php echo url("post-create-$tid-1");?>" method="post" id="quick_reply_form" class="d-block">	
			
								<div class="d-flex justify-content-between align-items-center text-muted" style="margin-top: 0.5rem;">
									<div class="action-icons">
										<!--{hook sq_thread_reply_left.htm}-->
										<i class="sq-icon-image sq-md-icon"></i>
									</div>
									<div>
										<!--{hook sq_thread_reply_right.htm}-->
									</div>
								</div>
								<div>
									
									<input type="hidden" name="doctype" value="1" />
									<input type="hidden" name="return_html" value="1" />
									<input type="hidden" name="quotepid" value="0" />
									
									<div class="message mt-1">
										<div class="input-group mb-3">
											<input type="text" id="message" name="message" class="form-control" placeholder="写评论...">
											<div class="input-group-append">
												<button class="btn btn-outline-secondary" type="submit" id="submit">发送</button>
											</div>
										</div>
										<textarea class="form-control" placeholder="<?php echo lang('message');?>" name="message" id="message"></textarea>
									</div>
										
								</div>
			
							</form>
						</div>
						-->
					</li>
					<?php } ?>
							
				</ul>
			</div>
		</div>

		<!--{hook thread_postlist_after.htm}-->
		
		<div class="d-none threadlist"><input type="checkbox" name="modtid" value="<?php echo $thread['tid']; ?>" checked /></div>
		<?php include _include(APP_PATH.'view/htm/thread_list_mod.inc.htm');?>
		
		<?php if($pagination) { ?>
		<nav><ul class="pagination my-4 justify-content-center flex-wrap"><?php echo $pagination; ?></ul></nav>
		<?php }?>
		
		<!--{hook thread_page_after.htm}-->
		
		<!--
		<a role="button" class="btn btn-secondary btn-block xn-back col-lg-6 mx-auto mb-3" href="javascript:history.back();"><?php echo lang('back');?></a>
		-->
	</div>
	<div class="col-lg-3 d-none d-lg-block aside">
	
		<a role="button" class="btn btn-primary btn-block mb-3" href="<?php echo url('thread-create-'.$fid);?>"><?php echo lang('thread_create_new');?></a>
		
		<div class="card card-user-info">
			<div class="m-3 text-center">
				<a href="<?php echo url("user-$thread[uid]");?>" tabindex="-1">
					<img class="avatar-5" src="<?php echo $thread['user_avatar_url'];?>">
				</a>
				<h5><a href="<?php echo url("user-".$thread['user']['uid']);?>"><?php echo $thread['user']['username'];?></a></h5>
				<!--{hook thread_user_username_after.htm}-->
			</div>
			<div class="card-footer p-2">
				<table class="w-100 small">
					<tr align="center">
						<td>
							<span class="text-muted"><?php echo lang('threads');?></span><br>
							<b><?php echo $thread['user']['threads'];?></b>
						</td>
						<!--{hook thread_user_threads_after.htm}-->
						<td>
							<span class="text-muted"><?php echo lang('posts');?></span><br>
							<b><?php echo $thread['user']['posts'];?></b>
						</td>
						<!--{hook thread_user_posts_after.htm}-->
						<td>
							<span class="text-muted"><?php echo lang('create_rank');?></span><br>
							<b><?php echo $thread['user']['uid'];?></b>
						</td>
						<!--{hook thread_user_uid_after.htm}-->
					</tr>
				</table>
			</div>
		</div>
		
		<!--{hook thread_user_after.htm}-->
		
	</div>

	<div id="sqFloatDiv">
		<div id="sqFloatReply">
			<div>
				<input id="bottomInput" type="text" placeholder="写评论..."/>
			</div>
			<div>
				<i class="sq-iconfont" id="bottomStar">
				<?php if($haya_favorite_check_favorite) { ?>
					&#xe621;
				<?php } else { ?>
					&#xe6c2;    
				<?php } ?>
				</i>
				<i class="sq-iconfont" id="bottomLike">
				<?php if($haya_post_like_thread_check) { ?>
					&#xe7bc;
				<?php } else { ?>
					&#xe7bb;
				<?php } ?>
				</i>
			</div>
		</div>
		<div id="sqHiddenReply">
			<div class="media-body">
				<!--
				<div class="d-flex justify-content-between small text-muted" id="sqPostFloor">
					<div>
						<div><?php echo $user['username'];?></div>
					</div>
					<div>
						<span class="floor" id="newfloor"><?php echo ($thread['posts'] + 2);?></span><?php echo lang('floor');?>
					</div>
				</div>
				-->
				
				<form action="<?php echo url("post-create-$tid-1");?>" method="post" id="quick_reply_form" class="d-block">	

					<div id="formTopActions">
						<div id="topActionsCancel">取消</div>
						<div>发表回复</div>
						<div>
							<button type="submit" id="submit">发表</button>
						</div>
					</div>
					<div>
						<input type="hidden" name="doctype" value="1" />
						<input type="hidden" name="return_html" value="1" />
						<input type="hidden" name="quotepid" value="0" />
						<div class="message">
							<!--
							<input type="text" id="message" name="message" class="form-control" placeholder="写评论...">
							<button class="btn" type="submit" id="submit">发送</button>
							-->
							<textarea name="message" id="message" placeholder="写评论..."></textarea>
						</div>
					</div>
					<div class="d-flex justify-content-between align-items-center text-muted">
						<div class="action-icons">
							<!--{hook sq_thread_reply_left.htm}-->
							<i class="sq-icon-image sq-md-icon"></i>
						</div>
						<div>
							<!--{hook sq_thread_reply_right.htm}-->
						</div>
					</div>

				</form>
			</div>
		</div>
	</div>

</div>
 
<!--{hook thread_end.htm}-->

<?php include _include(APP_PATH . SQ_MOBILE_PATH . 'view/htm/footer.inc.htm');?>

<script>
var jform = $('#quick_reply_form');
var jsubmit = $('#submit');
jform.on('submit', formSubmit);

function formSubmit() {
	jform.reset();
	jsubmit.button('loading');
	var formContent = $('#quick_reply_form');
	var postdata = formContent.serialize();
	$.xpost(jform.attr('action'), postdata, function(code, message) {
		if(code == 0) {
			var s = '<ul>'+message+'</ul>';
			var jli = $(s).find('li');
			jli.insertBefore($('.postlist > .post').last());
			jsubmit.button('reset');
			$('#message').val('');
			
			// 楼层 +1
			var jfloor = $('#newfloor');
			jfloor.html(xn.intval(jfloor.html()) + 1);
			
			// 回复数 +1
			var jposts = $('.posts');
			jposts.html(xn.intval(jposts.html()) + 1);

			// 处理加积分的信息
			var liPid = $(jli).attr('data-pid');
			setTimeout(function() {
				$('li[data-pid=' + liPid + ']').find('.alert.alert-danger').addClass('sq-not-play');
			}, 3000);

			// 关闭浮动输入框
			$('#sqFloatDiv').click();
			$('#bottomInput').val('');
			$.alert('发送成功');
			
		} else if(code < 0) {
			$.alert(message);
			jsubmit.button('reset');
		} else {
			// jform.find('[name="'+code+'"]').alert(message).focus();
			$.alert(message);
			jsubmit.button('reset');
			if(message == '请先登录') {
				setTimeout(function(){
					window.location = '<?php echo url("user-login");?>'; // 如果是未登录的话，跳转到登录页
				}, 1000);
			}
		}
	});
	return false;
}


// 缩放图片，适应屏幕大小。
function resize_image() {
	var jmessagelist = $('div.message');
	var first_width = jmessagelist.width(); // 815 : 746; //  734 746
	jmessagelist.each(function() {
		var jdiv = $(this);
		var maxwidth = jdiv.attr('isfirst') ? first_width : jdiv.width(); //  734 746
		var jmessage_width = Math.min(jdiv.width(), maxwidth);
		jdiv.find('img, embed, iframe, video').each(function() {
			var jimg = $(this);
			var img_width = this.org_width;
			var img_height = this.org_height;
			if(!img_width) {
				var img_width = jimg.attr('width');
				var img_height = jimg.attr('height');
				this.org_width = img_width;
				this.org_height = img_height;
			}
			//var percent = xn.min(100, xn.ceil((img_width / jmessage_width) * 100));
			if(img_width > jmessage_width) {
				if(this.tagName == 'IMG') {
					jimg.width(jmessage_width);
					jimg.css('height', 'auto');
					jimg.css('cursor', 'pointer');
					jimg.on('click', function() {
						//window.open(jimg.attr('src'));
					});
				} else {
					jimg.width(jmessage_width);
					var height = (img_height / img_width) * jimg.width();
					jimg.height(height);
				}
			}
		});
	});
}

// 对于超宽的表格，加上响应式
function resize_table() {
	$('div.message').each(function() {
		var jdiv = $(this);
		jdiv.find('table').addClass('table').wrap('<div class="table-responsive"></div>'); 
	});
}

var openFloatInput = 0; // 初始化状态

$(function() {
	resize_image();
	resize_table();
	$(window).on('resize', resize_image);
	// 将底部菜单的第二个板块按钮根据现在的板块设置active样式
	var fid = "<?php echo $fid; ?>";
	var forumName = $('li[forum-id=' + fid + ']>a').html();
	$('#bottom-menu>li:eq(1)>a>span').html(forumName);
	$('#bottom-menu>li:eq(1)>a>div').addClass('icon-active');

/** 原来浮动输入框应该在列表中点击才打开的逻辑
	$(window).on('resize', function(){ // 将输入框返回原位
		if(openFloatInput) {
			$('.sq-bottom-nav').css('display', 'none');
		} else {
			$('.sq-bottom-nav').css('display', 'block');
		}
	});
**/
	$(window).on('resize', function() { // 如果窗口大小变化，一般是键盘隐藏，那么应该去掉表情框之类
		var isDisplay = $('#sqHiddenReply').css('display');
	});
	$('.sq-bottom-nav').css('display', 'none');
});

var jmessage = $('#bottomInput');
jmessage.on('focus', floatInput);

// 处理引用的问题
$('.post .post_reply').on('click', function(){
	var thisNode = $(this);
	var quoteNode = $('input[name=quotepid]');
	var quotepid = quoteNode.val();
	if(thisNode.attr('data-pid') == quotepid) {
		quoteNode.val(0);
	} else {
		quoteNode.val(thisNode.attr('data-pid'));
	}
	$('#bottomInput').focus();
});

// 处理弹出层的冒泡行为
$('#quick_reply_form').on('click', function(e){
	e.stopPropagation();
});
$('.emotion').on('click', function(e){
	$('#imagebox') && $('#imagebox').remove();
});
$('textarea[name=message]').on('click', function(e){
	var isDisplay = $('#sqFloatReply').css('display');
	if(isDisplay == 'none') {
		$('#facebox').remove();
		$('#imagebox').remove();
	}
});
$('#topActionsCancel').on('click', function(e) {
	resetInput();
});
$('#bottomStar').on('click', function(){
	$('#sqFavorite').click();
});
$('#bottomLike').on('click', function(){
	$('#sqLike').click();
});

/** 上浮输入框 **/
function floatInput() {
	var sqHiddenReply = $('#sqHiddenReply'),
	sqFloatReply  = $('#sqFloatReply'),
	sqFloatDiv    = $('#sqFloatDiv');

	sqHiddenReply.css('display', 'block');
	sqFloatReply.css('display', 'none');
	sqFloatDiv.css('position', 'fixed');

	sqFloatDiv.one('click', resetInput);
	sqFloatDiv.css('min-height', '100%');
	sqFloatDiv.css('background-color', 'rgba(0,0,0,0.6)');
	sqFloatDiv.on('touchmove', notAllowMove);

	$('#scroll_to_top') && $('#scroll_to_top').css('display', 'none');

	openFloatInput = 1; // 开启了浮动输入框

	$('#message').focus(); // 焦点
}

/** 重置输入框 **/
function resetInput() {
	var sqHiddenReply = $('#sqHiddenReply'),
		sqFloatReply  = $('#sqFloatReply'),
		sqFloatDiv    = $('#sqFloatDiv');

	sqHiddenReply.css('display', 'none');
	sqFloatReply.css('display', 'flex');
	sqFloatDiv.css('position', 'absolute');
	sqFloatDiv.css('background-color', '');
	//sqFloatDiv.css('min-height', '0');

	$('#scroll_to_top') && $('#scroll_to_top').css('display', 'block');

	$('#facebox') && $('#facebox').remove();
	$('#imagebox') && $('#imagebox').remove();

	var message = $('#message').val(); // 将值带回去底部输入框
	$('#bottomInput').val(message);

	openFloatInput = 0; // 关闭了浮动输入框

	sqFloatDiv.off('click', resetInput);
	sqFloatDiv.off('touchmove', notAllowMove);
}

/** 禁止拖动 **/
function notAllowMove(e) {
	e.preventDefault();
}

/**
var jmessage = $('#message');
jmessage.on('focus', floatInput);

var sqClientHeight = document.body.clientHeight;

function floatInput() {
	// 获得需要处理的div
	var sqReplyContainer = $('#sqReplyContainer'), // 列表里面的表单div
		sqFloatDiv       = $('#sqFloatDiv'), // 
		sqFloatReply     = $('#sqFloatReply');

	sqReplyContainer.find('#sqPostFloor').addClass('sq-not-play'); // 浮动的时候不让楼层信息显示
	var formHtml = sqReplyContainer.html(); // 获得表单内容

	//  1.整个floatReply显示
	sqFloatDiv.css('height', $(document).height() + 'px'); // 设置整个浮动层的高
	sqFloatDiv.css('display', 'block');
	sqFloatDiv.on('click', resetInput); // 注册点击事件
	// $('body').one('click', resetInput);
	$('.sq-bottom-nav').css('display', 'none'); // 隐藏底部菜单

	openFloatInput = 1; // 开启浮动输入框

	var inputData = returnInputStatus(sqReplyContainer); // 获得现在输入框的值
	// console.log(inputData);
	sqReplyContainer.html(''); // 清空ul列表里面的回复框html

	sqFloatReply.html(formHtml); // 添加表单html到浮动输入表单里面
	changeInputStatus(sqFloatReply, inputData); // 将获得的信息填写到新的表单里面
	
	// 由于之前的删除了html，所以事件也删除了，这里重新注册
	$('.emotion').on('click', function(){
		$('#imagebox') && $('#imagebox').remove();
	});
	$('.emotion').qqFace({
		id : 'facebox', 
		assign:'message',
		floatContent: 1,
		path:'plugin/Ty_face/face/arclist/'	//?������֪��
	});

	// 当点击的新出来的输入框的时候，阻止冒泡并focus输入框，而且remove掉表情组
	$('#message').on('click', function(e){
		$('#message').focus();
		$('#facebox') && $('#facebox').remove();
		$('#imagebox') && $('#imagebox').remove();
		e.stopPropagation();
	});
	$('.sq-checkbox-label').on('click', function(e){ // 阻止匿名回帖的冒泡
		e.stopPropagation();
	});
	$('.sq-icon-image').on('click', function(e){
		openUploadDiv();
		e.stopPropagation();
	});

	$('#quick_reply_form').on('submit', formSubmit); // 为表单注册提交事件
	sqFloatReply.find('input[name=message]').focus();
}

function resetInput(e) {
	var target = $(e.target);
	if(target.attr('id') == 'submit') { // 如果点击的是submit按钮的话，阻止其冒泡
		$('#facebox').remove();
		e.stopPropagation();
		return;
	}

	var sqFloatDiv   = $('#sqFloatDiv'),
		sqFloatReply = $('#sqFloatReply'),
		sqReplyContainer = $('#sqReplyContainer');

	var sqReplyHtml = sqReplyContainer.html(); // ul列表里面的回复框内容

	if(!sqReplyHtml) { // 当ul列表里面的回复框为空才执行下面的操作

		$('.sq-bottom-nav').css('display', 'none');

		// 去除多余的内容
		$('#facebox') && $('#facebox').remove();
		$('#imagebox') && $('#imagebox').remove();

		var sqFloatReplyHtml = sqFloatReply.html(); // 浮动输入框的内容

		var inputData = returnInputStatus(sqFloatReply); // 获得现在浮动输入框的值
		// console.log(inputData);
		sqFloatReply.html(''); // 清空浮动输入框的html内容
		sqFloatDiv.css('display', 'none'); // 隐藏整个浮动层

		openFloatInput = 0; // 关闭浮动输入框

		sqReplyContainer.html(sqFloatReplyHtml); // 将浮动输入框的内容重新填装到列表里面
		changeInputStatus(sqReplyContainer, inputData);

		// 由于之前的删除了html，所以事件也删除了，这里重新注册
		$('.emotion').qqFace({
			id: 'facebox', 
			assign:'message',
			path:'plugin/Ty_face/face/arclist/'	//?������֪��
		});
		$('.sq-icon-image').on('click', openUploadDiv);

		$('#quick_reply_form').on('submit', formSubmit); // 为表单注册提交事件

		sqReplyContainer.find('#sqPostFloor').removeClass('sq-not-play');
		sqReplyContainer.find('input[name=message]').on('focus', floatInput);

	}

	if(!openFloatInput) { // 只有不是开启了浮动输入框的时候，才显示底部菜单
		$('.sq-bottom-nav').css('display', 'block');
	}

}

function returnInputStatus(node) {
	var result = {
		doctype: node.find('input[name=doctype]').val(),
		return_html: node.find('input[name=return_html]').val(),
		quotepid: node.find('input[name=quotepid]').val(),
		message: node.find('input[name=message]').val(),
		is_secret: node.find('input[name=is_secret]').is(':checked')
	};

	return result;
}
function changeInputStatus(node, inputData) {
	node.find('input[name=doctype]').val(inputData.doctype);
	node.find('input[name=return_html]').val(inputData.return_html);
	node.find('input[name=quotepid]').val(inputData.quotepid);
	node.find('input[name=message]').val(inputData.message);
	if (inputData.is_secret) {
		node.find('input[name=is_secret]').attr('checked', true);
	}
}
**/

$('.sq-icon-image').on('click', openUploadDiv); // 注册点击事件
/** 开启上传图片的div */
function openUploadDiv() {
	<?php if(empty($user)) { ?>
	$.alert('请先登录');
	return;
	<?php } ?>

	$('#imagebox') && $('#imagebox').remove();
	$('#facebox') && $('#facebox').remove();

	$.ajax({
		type: 'GET',
		url: '<?php echo url("attach-getsess"); ?>',
		success: function(data) {
			data = JSON.parse(data);
			var imageHtml = '<div id="imagebox">' +
							data.data +
							'	<div class="image-add">' +
							'		<label style="width: 100%; height: 100%;">'+
							'			<img src="./plugin/sq_independent_mobile/view/images/icon/add.png"/>' +
							'			<input type="file" id="inputImg" multiple="multiple" style="width: 0; height: 0; display: none;" />' +
							'		</label>' +
							'	</div>' +
							'</div>';

			$('#sqHiddenReply').append(imageHtml);

			var imagebox = $('#imagebox');
			var divWidth = imagebox.width() / 4.2;
			var divMargin = (imagebox.width() - (4 * divWidth)) / 4;

			$('#imagebox .image-add').css({width: divWidth, height: divWidth});
			$('#imagebox .sq-img-div').css({width: divWidth, height: divWidth});

			$('#imagebox').on('click', function(e){ // 阻止冒泡
				e.stopPropagation();
			});
			$('#inputImg').on('change', inputImgChange);
			
			$('#message').blur();
		}
	});
}

/** 开启上传图片的div
function openUploadDiv() {
	if (!openFloatInput) {
		$('#message').focus(); // 让其
	} else {
		if($('#facebox')) $('#facebox').remove(); // 如果现在已经打开了表情框，先去掉
	}

	$('#imagebox') && $('#imagebox').remove();

	$.ajax({
		type: 'GET',
		url: '<?php echo url("attach-getsess"); ?>',
		success: function(data) {
			data = JSON.parse(data);
			var imageHtml = '<div id="imagebox">' +
							data.data +
							'	<div class="image-add">' +
							'		<label style="width: 100%; height: 100%;">'+
							'			<img src="./plugin/sq_independent_mobile/view/images/icon/add.png"/>' +
							'			<input type="file" id="inputImg" multiple="multiple" style="width: 0; height: 0; display: none;" />' +
							'		</label>' +
							'	</div>' +
							'</div>';

			$('#sqFloatReply').append(imageHtml);

			var imagebox = $('#imagebox');
			var divWidth = imagebox.width() / 4.2;
			var divMargin = (imagebox.width() - (4 * divWidth)) / 4;

			$('#imagebox .image-add').css({width: divWidth, height: divWidth});
			$('#imagebox .sq-img-div').css({width: divWidth, height: divWidth});

			$('#imagebox').on('click', function(e){ // 阻止冒泡
				e.stopPropagation();
			});
			$('#inputImg').on('change', inputImgChange);
			
			$('#message').blur();
		}
	});

}
*/

$('#inputImg').on('change', inputImgChange);

function inputImgChange(e){
	var files = xn.get_files_from_event(e);

	var div = $('#imagebox');
	var containerWidth = div.width();
	var divWidth = divHeight = containerWidth / 4.2;
	var divMargin = (containerWidth - (4 * divWidth)) / 4;

	if (!files) return;

	// 判断用户上传的是否为图片格式，如果不是，阻止其上传
	var flag = true;
	for (var i = 0; i < files.length; i++) {
		var filetype = files[i].type;
		if(filetype) {
			if(filetype.indexOf('image') < 0) {
				flag = false;
				break;
			}
		} else {
			flag = false;
			break;
		}
	}
	if (!flag) {
		$.alert('请上传图片格式的文件');
		return;
	}

	$.each_sync(files, function(i, callback) {
		var file = files[i];
		xn.upload_file(file, xn.url('attach-create'), {is_image: 1, not_sess: 1}, function(code, message) {
			if (code != 0) return $.alert(message);
			// 把文件 append 到附件列表
			var url = message.url;
			var filetype = message.filetype;
			var aid = message.aid;
			var deleteIcon = '<span class="img-delete-icon" onclick="sqDeleteImg(this);"></span>';
			var divStr = '<div class="sq-img-div" data-id="' + aid + '" style="width: ' + divWidth + 'px; height: ' + divHeight + 'px; margin-right: ' + divMargin + 'px; background-image: url(' + message.url + ')">' + deleteIcon + '</div>';
			$('.image-add').before(divStr);
			callback();
		}
		// function(percent) {
		// 	percent = xn.intval(percent);
		// 	jprogressbar.css('width', percent+'%');
		// 	jprogressbar.text(percent+'%');
		// 	jprogress.show();
		// 	console.log('progress:'+ percent); 
		// }
		);
	});
};

function sqDeleteImg(node) {
	var jlink = $(node);
	var jli = jlink.parent();
	var aid = jli.attr('data-id');
	// console.log(aid);
	if(!window.confirm(lang.confirm_delete)) return false;
	$.xpost(xn.url('attach-delete-'+aid+'-sq'), function(code, message) {
		if(code != 0) return $.alert(message);
		jlink.parent().remove();
	});
	return false;
};


$('li[data-active="fid-<?php echo $fid;?>"]').addClass('active');

</script>

<?php if($thread['closed'] && ($gid == 0 || $gid > 5)) { ?>
<script>
jmessage.val('<?php echo lang('thread_has_already_closed');?>').attr('readonly', 'readonly');
</script>
<?php } ?>
<!--{hook thread_js.htm}-->